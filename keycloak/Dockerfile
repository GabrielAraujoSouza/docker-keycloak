FROM quay.io/keycloak/keycloak:17.0.1 as builder

ARG KC_DB
ARG KC_METRICS_ENABLED

ENV KC_METRICS_ENABLED=${KC_METRICS_ENABLED}
#ENV KC_FEATURES=token-exchange
ENV KC_DB=${KC_DB}

RUN /opt/keycloak/bin/kc.sh build

FROM quay.io/keycloak/keycloak:17.0.1

ARG KC_DB_URL_HOST
ARG KC_DB_URL_DATABASE
ARG KC_DB_USERNAME
ARG KC_DB_PASSWORD
ARG KC_DB_SCHEMA
ARG KEYCLOAK_ADMIN
ARG KEYCLOAK_ADMIN_PASSWORD
ARG KC_HOSTNAME
ARG KC_HTTPS_PORT

COPY --from=builder /opt/keycloak/lib/quarkus/ /opt/keycloak/lib/quarkus/
WORKDIR /opt/keycloak

COPY ./keystore.jks conf/server.keystore

# server
ENV KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN}
ENV KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
ENV KC_HTTPS_PORT=${KC_HTTPS_PORT}

# database
ENV KC_DB_URL_HOST=${KC_DB_URL_HOST}
ENV KC_DB_URL_DATABASE=${KC_DB_URL_DATABASE}
ENV KC_DB_USERNAME=${KC_DB_USERNAME}
ENV KC_DB_PASSWORD=${KC_DB_PASSWORD}
ENV KC_DB_SCHEMA=${KC_DB_SCHEMA}
ENV KC_HOSTNAME=${KC_HOSTNAME}

ENTRYPOINT ["/opt/keycloak/bin/kc.sh", "start"]

